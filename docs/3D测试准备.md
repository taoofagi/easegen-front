# 3D数字人视频合成测试准备

## 测试状态

✅ 代码已实现并提交 (commit: 499cfd3ce)
✅ 数据库结构已升级
✅ 系统配置已完成（用户确认）
✅ 应用已重启并运行在端口 48080

## 测试前需要提供的信息

### 1. 登录凭据
为了调用API接口，需要提供：
- **用户名**: ________
- **密码**: ________

当前尝试使用 admin/admin123 登录失败，提示"账号密码不正确"。

### 2. 测试方式选择

#### 方式一：PPT方式（推荐）
需要提供：
- **PPT文件的URL地址**（已上传到OSS的PPTX文件）
- 示例：`https://oss.example.com/test/course.pptx`

#### 方式二：Segment方式（文本片段）
需要提供：
- **测试文本内容**（数字人要讲解的文字）
- **配图URL**（可选，作为背景图片）

### 3. 魔珐星云3D配置参数

需要确认以下参数的有效值（从魔珐星云平台获取）：

| 参数 | 说明 | 示例值 | 是否必填 |
|------|------|--------|---------|
| `lookName` | 数字人形象名称 | `caihongwei_3663_new` | ✅ |
| `ttsVcnName` | 音色名称 | `XMOV_EN_TTS__13` | ✅ |
| `studioName` | 演播室名称 | `telestudio_simple_red_01` | ✅ |
| `subTitle` | 字幕开关 | `on` 或 `off` | ✅ |
| `ifAigcMark` | AI生成标识 | `1`（显示）或 `0`（不显示） | ✅ |

### 4. 系统配置验证

需要确认 `infra_config` 表中已配置：
- ✅ `xingyun3d.app.id` = 您的App ID
- ✅ `xingyun3d.app.secret` = 您的App Secret
- ✅ `xingyun3d.gateway.server` = `https://nebula-agent.xingyun3d.com`（默认值）

## 测试步骤

### 步骤1：登录获取Token
```bash
curl -X POST "http://localhost:48080/admin-api/system/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "YOUR_USERNAME",
    "password": "YOUR_PASSWORD"
  }'
```

预期返回：
```json
{
  "code": 0,
  "data": {
    "accessToken": "xxxxx",
    "userId": 1
  }
}
```

### 步骤2：创建3D视频合成任务

#### 方式一：使用PPT
```bash
curl -X POST "http://localhost:48080/admin-api/digitalcourse/course-media/meger" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -d '{
    "id": 1,
    "name": "测试3D数字人PPT课程",
    "platformType": 2,
    "lookName": "caihongwei_3663_new",
    "ttsVcnName": "XMOV_EN_TTS__13",
    "studioName": "telestudio_simple_red_01",
    "subTitle": "on",
    "ifAigcMark": 1,
    "synthesisType": "ppt",
    "pptFileUrl": "YOUR_PPT_URL"
  }'
```

#### 方式二：使用文本片段
```bash
curl -X POST "http://localhost:48080/admin-api/digitalcourse/course-media/meger" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -d '{
    "id": 1,
    "name": "测试3D数字人文本课程",
    "platformType": 2,
    "lookName": "caihongwei_3663_new",
    "ttsVcnName": "XMOV_EN_TTS__13",
    "studioName": "telestudio_simple_red_01",
    "subTitle": "on",
    "ifAigcMark": 1,
    "synthesisType": "segment",
    "reqJson": {
      "segments": [
        {
          "text": "这是一条测试数据，用于验证3D数字人视频合成功能。",
          "media_url": "https://example.com/image1.jpg"
        },
        {
          "text": "第二段测试文本，展示多段落讲解能力。",
          "media_url": "https://example.com/image2.jpg"
        }
      ]
    }
  }'
```

预期返回：
```json
{
  "code": 0,
  "data": true,
  "msg": "操作成功"
}
```

### 步骤3：查询任务状态

任务创建后，定时任务会每30秒自动查询状态。也可以手动查询数据库：

```sql
SELECT
    id,
    name,
    platform_type,
    platform_task_id,
    synth_status,
    status,
    media_url,
    error_reason,
    synth_start_time,
    synth_finish_time
FROM digital_course_course_media
WHERE platform_type = 2
ORDER BY id DESC
LIMIT 10;
```

**状态映射：**
- `status = 1`: 合成中
- `status = 2`: 合成成功
- `status = 3`: 合成失败
- `synth_status`: 魔珐星云返回的详细状态
  - `not_send`: 未发送
  - `waiting`: 等待中
  - `processing`: 处理中
  - `finished`: 已完成（会自动下载视频并上传到OSS）
  - `error`: 错误
  - `cancel`: 已取消

### 步骤4：取消任务（可选）

如果需要取消某个任务：
```bash
curl -X POST "http://localhost:48080/admin-api/digitalcourse/course-media/cancel" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -d '{
    "courseMediaId": YOUR_COURSE_MEDIA_ID
  }'
```

## 测试验证点

### 功能测试
- [ ] PPT方式创建任务成功
- [ ] Segment方式创建任务成功
- [ ] 任务状态自动更新（通过定时任务）
- [ ] 视频合成成功后自动下载并上传到OSS
- [ ] 取消任务功能正常

### 异常测试
- [ ] 配置缺失时的错误提示
- [ ] API调用失败时的重试机制
- [ ] 网络超时的处理
- [ ] 错误原因记录到 error_reason 字段

### 兼容性测试
- [ ] 2D功能不受影响（platformType=1）
- [ ] 现有数据正常工作

## 日志监控

测试时关注以下日志：

1. **任务创建日志**：
```
魔珐星云3D - 创建渲染任务（PPT方式）
魔珐星云3D - 创建渲染任务（Segment方式）
```

2. **状态查询日志**：
```
魔珐星云3D - 查询渲染任务状态
```

3. **视频下载日志**：
```
魔珐星云3D - 视频下载并上传到OSS
```

4. **错误日志**：
```
魔珐星云3D - API调用失败
```

## 需要您提供的测试数据

请提供以下信息以便进行完整测试：

1. **登录凭据**：有效的用户名和密码
2. **测试方式**：选择PPT方式或Segment方式
3. 如果选择PPT方式：
   - 提供PPT文件的OSS URL
4. 如果选择Segment方式：
   - 提供测试文本内容
   - 提供配图URL（可选）
5. **魔珐星云参数**：确认 lookName、ttsVcnName、studioName 等参数的有效值

收到以上信息后，我将立即执行完整的测试流程。
