# 3D数字人课程制作功能说明

## 概述

基于魔珐星云平台的3D数字人课程制作功能，支持PPT上传、3D场景选择、数字人形象选择、音色配置和口播稿编辑。

## 文件结构

```
src/views/choose3DTemplate/
├── index.vue                      # 主页面（刚创建）
├── types.ts                       # TypeScript类型定义
└── components/
    ├── StudioSelector.vue         # 演播室场景选择器
    ├── LookSelector.vue           # 数字人形象选择器
    ├── VoiceSelector.vue          # 音色选择器
    └── ScriptEditor.vue           # 口播稿编辑器

src/assets/data/
├── 3d场景信息.json                # 演播室场景数据
├── 3d形象信息.json                # 数字人形象数据
└── 3d音色信息.json                # 音色数据
```

## 功能特性

### 1. PPT上传与解析
- 支持 `.pptx` 和 `.pdf` 文件上传
- 自动解析生成场景列表
- 实时显示解析进度（0-100%）
- 支持取消解析操作

### 2. 场景管理
- **拖拽排序**: 使用 `vuedraggable` 实现场景拖拽重排
- **复制场景**: 一键复制任意场景
- **删除场景**: 单个删除或批量删除
- **场景选择**: 点击切换当前编辑场景
- **自动页码**: 删除/复制后自动重新计算页码

### 3. 3D资源配置

#### 演播室场景 (StudioSelector)
- **筛选维度**:
  - 场景风格: 现代简约、商务正式、生活日常、党建教育等
  - 场景类型: 大舞台、小舞台、特写站姿、室内坐姿等
  - 画幅: 横屏/竖屏
- **场景预览**: 支持视频预览
- **数据来源**: `3d场景信息.json` (84个场景)

#### 数字人形象 (LookSelector)
- **筛选维度**:
  - 性别: 男/女
  - 年龄段: 20-40岁、41-50岁、51-60岁
  - 风格: 正装、休闲装、运动装
- **形象预览**: 支持面部动画视频预览
- **数据来源**: `3d形象信息.json` (200+形象)

#### 音色选择 (VoiceSelector)
- **筛选维度**:
  - 性别: 男声/女声
  - 语言: 中文/英文
  - 风格: 温和、活力、可爱、温暖
- **试听功能**: 点击试听音色示例
- **数据来源**: `3d音色信息.json` (164个音色)

### 4. 口播稿编辑 (ScriptEditor)
- **实时统计**:
  - 字数统计
  - 预计时长（按200字/分钟计算）
- **字数建议**: 50-1000字最佳
- **字数限制**: 最多5000字
- **自动保存**: 编辑后自动更新场景数据

### 5. 数据统计
- **总字数**: 所有场景口播稿字数总和（自动去除SSML标签）
- **预计时长**: 自动计算总时长（HH:MM:SS格式）
- **当前页信息**: 显示当前页码、字数、时长

### 6. 保存与合成

#### 保存课程
- 保存所有场景数据
- 保存3D资源配置（演播室、形象、音色）
- 显示最后保存时间

#### 合成3D视频
**前置校验**:
1. 演播室场景必选
2. 数字人形象必选
3. 音色必选
4. PPT至少有一页
5. 每页口播稿不能为空

**合成参数**:
```typescript
{
  platformType: 2,           // 魔珐星云
  synthesisType: 'segment',  // 文本片段方式
  ifAigcMark: 0,             // 不显示AI标识
  subTitle: 'on' | 'off',    // 字幕开关

  studioName: string,        // 演播室英文名
  lookName: string,          // 形象名称
  ttsVcnName: string,        // 音色ID

  text: string,              // 所有口播稿拼接（防止多<speak>标签）
  scenes: Scene3D[],         // 场景数组
  expectedDuration: number   // 预计时长（秒）
}
```

**合成流程**:
1. 参数校验
2. 拼接文本（去除已有的`<speak>`标签，防止多标签问题）
3. 先保存课程
4. 提交合成任务到后端
5. 跳转到课程中心

## 数据结构

### Course3DInfo (课程信息)
```typescript
{
  id: number
  accountId: number
  aspect: '16:9' | '9:16'
  name: string
  duration: number           // 秒
  status: number
  pageMode: 2                // PPT课件模式
  matting: 0                 // 3D不需要抠图
  width: number              // 像素
  height: number             // 像素
  platformType: 2            // 魔珐星云
  synthesisType: 'segment'
  ifAigcMark: 0
  subTitle: 'on' | 'off'
}
```

### Scene3D (场景)
```typescript
{
  id: string                 // UUID
  pictureUrl: string         // PPT页面图片
  pptRemark: string          // 口播稿
  pageIndex: number          // 页码（从1开始）
  duration: number           // 预估时长（秒）
  width: number
  height: number
  isActive: boolean          // 是否选中
  isChecked: boolean         // 是否勾选
}
```

### Selected3DResources (3D资源)
```typescript
{
  studio: Studio3D | null    // 演播室
  look: Look3D | null        // 形象
  voice: Voice3D | null      // 音色
}
```

## API接口

### PPT相关
- `POST /digitalcourse/courses/create` - 创建课程ID
- `POST /digitalcourse/course-ppts/create` - 创建PPT记录
- `GET /digitalcourse/course-ppts/getSchedule?id=` - 轮询解析进度
- `POST /digitalcourse/courses/update` - 保存课程

### 合成相关
- `POST /digitalcourse/course-media/megerMedia` - 提交合成任务

### 查询相关
- `GET /digitalcourse/courses/get?id=` - 获取课程详情

## 页面布局

```
┌─────────────────────────────────────────────────────────┐
│  返回 | 课程名(可编辑) | 预计时长 | 字数 | 保存 | 合成     │
├──────────┬──────────────────────────┬──────────────────┤
│  左侧    │     中间预览区            │    右侧配置栏     │
│  (240px) │                          │    (400px)       │
│          │                          │                  │
│  PPT     │  - 显示当前选中的PPT页    │  Tab切换：       │
│  页面    │  - 只读展示              │  1. 演播室场景   │
│  列表    │  - 屏幕比例选择          │  2. 数字人形象   │
│          │  - 当前页信息            │  3. 音色选择     │
│  可拖拽   │                          │  4. 口播稿编辑   │
│  排序    │                          │                  │
│          │                          │                  │
│  复制/   │                          │                  │
│  删除    │                          │                  │
└──────────┴──────────────────────────┴──────────────────┘
```

## 关键技术点

### 1. SSML标签处理
防止多个`<speak>`标签导致语音合成失败：
```typescript
const allText = pptScenes.value
  .map((s) => s.pptRemark.replace(/<\/?speak>/g, '').trim())
  .join('\n\n')
```

### 2. 时长计算
按照200字/分钟的语速：
```typescript
const getSceneDuration = (scene: Scene3D): number => {
  const wordCount = getSceneWordCount(scene)
  return Math.ceil((wordCount / 200) * 60)
}
```

### 3. 字数统计
去除SSML标签后统计：
```typescript
const getSceneWordCount = (scene: Scene3D): number => {
  if (!scene.pptRemark) return 0
  const plainText = scene.pptRemark.replace(/<[^>]+>/g, '')
  return plainText.trim().length
}
```

### 4. 响应式视图
根据屏幕比例调整预览尺寸：
```typescript
watch(() => course3DInfo.value.aspect, (newAspect) => {
  if (newAspect === '16:9') {
    viewSize.width = 600
    viewSize.height = 338
  } else {
    viewSize.width = 338
    viewSize.height = 600
  }
})
```

## 样式设计

- **主题色**: 紫色系 (#7c3aed, #a78bfa)
- **组件库**: Element Plus
- **布局**: Flexbox
- **卡片阴影**: `box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08)`
- **悬停效果**: 边框颜色变化 + 阴影加深
- **选中状态**: 紫色边框 + 外发光

## 使用流程

1. **上传PPT**: 点击上传按钮，选择PPTX或PDF文件
2. **等待解析**: 系统自动解析PPT为场景列表（2秒轮询）
3. **配置3D资源**:
   - 选择演播室场景（可预览视频）
   - 选择数字人形象（可预览动画）
   - 选择音色（可试听）
4. **编辑口播稿**: 为每一页PPT编写口播内容
5. **保存课程**: 点击保存按钮
6. **合成视频**: 点击"合成3D视频"，系统自动校验并提交

## 注意事项

1. **口播稿必填**: 每页都必须有口播稿，否则无法合成
2. **3D资源必选**: 演播室、形象、音色三者缺一不可
3. **文本拼接**: 自动处理SSML标签，防止语法错误
4. **视频时长**: 单位为毫秒（后端要求）
5. **自动保存**: 合成前会自动保存一次

## 扩展建议

1. **批量操作**: 批量编辑口播稿、批量应用配置
2. **模板系统**: 保存常用的3D资源组合
3. **实时预览**: 3D数字人实时预览（需要3D渲染支持）
4. **AI生成**: 自动根据PPT内容生成口播稿
5. **素材库**: 支持自定义背景音乐、字幕样式

## 相关文档

- [2D数字人课程制作](../views/chooseTemplate/index.vue)
- [PPT解析API](../api/pptTemplate/index.ts)
- [类型定义](../views/choose3DTemplate/types.ts)
