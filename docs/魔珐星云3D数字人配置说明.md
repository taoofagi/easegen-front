# 魔珐星云3D数字人配置说明

## 一、数据库升级

### 1.1 执行SQL脚本

执行数据库升级脚本：`docs/sql/upgrade_course_media_for_3d.sql`

```bash
# 在数据库中执行以下脚本
mysql -u root -p easegen < docs/sql/upgrade_course_media_for_3d.sql
```

### 1.2 升级内容

为 `digitalcourse_course_media` 表新增以下字段：
- `platform_type`: 平台类型（1-2D，2-3D）
- `platform_task_id`: 平台任务ID
- `look_name`: 数字人形象名称（3D使用）
- `tts_vcn_name`: 音色名称（3D使用）
- `studio_name`: 演播室名称（3D使用）
- `sub_title`: 字幕开关（3D使用）
- `if_aigc_mark`: 是否显示AI生成标识（3D使用）
- `parse_ppt_file_name`: PPT解析文件名（3D使用）
- `synth_status`: 合成状态（3D使用）
- `synth_start_time`: 合成开始时间（3D使用）
- `synth_finish_time`: 合成完成时间（3D使用）

---

## 二、系统配置

### 2.1 配置项说明

在系统配置管理界面（http://localhost/infra/config）添加以下配置项：

| 配置键 | 配置名称 | 配置值示例 | 说明 |
|--------|---------|-----------|------|
| `xingyun3d.app.id` | 魔珐星云App ID | `your_app_id` | 从魔珐星云平台获取的应用ID（**必填**） |
| `xingyun3d.app.secret` | 魔珐星云App Secret | `your_app_secret` | 从魔珐星云平台获取的应用密钥（**必填**） |
| `xingyun3d.gateway.server` | 魔珐星云网关地址 | `https://nebula-agent.xingyun3d.com` | 网关服务器地址（**可选**，默认值：`https://nebula-agent.xingyun3d.com`） |

**说明**：
- 3D数字人功能默认启用，无需配置开关
- 超时时间、重试次数等参数已硬编码在代码中（超时30秒，重试3次）
- 如需修改这些参数，需要修改代码中的默认值

### 2.2 配置步骤

1. **登录系统管理后台**
   - 访问：http://localhost/infra/config

2. **添加配置项**
   - 点击"新增"按钮
   - 依次添加上述配置项（只需添加必填项即可）
   - 配置键和配置值按照上表填写

3. **配置示例**

**必填配置1：App ID**
```
配置键: xingyun3d.app.id
配置名称: 魔珐星云App ID
配置值: 37514ac0-3fce-4f4c-bc3f-86eba37da7dd
配置类型: 输入框
```

**必填配置2：App Secret**
```
配置键: xingyun3d.app.secret
配置名称: 魔珐星云App Secret
配置值: bb81b706-ef1f-443e-9e86-9df8399f796b
配置类型: 输入框（敏感信息）
```

**可选配置：网关地址**（有默认值，可不配置）
```
配置键: xingyun3d.gateway.server
配置名称: 魔珐星云网关地址
配置值: https://nebula-agent.xingyun3d.com
配置类型: 输入框
```

### 2.3 获取魔珐星云配置信息

1. **登录魔珐星云平台**
   - 访问：https://xingyun3d.com/
   - 注册/登录账号

2. **创建应用**
   - 进入"应用中心"
   - 创建"视频生成"应用
   - 获取App ID和App Secret

3. **配置说明**
   - App ID：应用标识
   - App Secret：应用密钥（请妥善保管）

---

## 三、代码实现

### 3.1 已实现的功能

1. **签名工具** (`Xingyun3dSignatureUtil`)
   - X-TOKEN签名生成
   - 支持MD5加密

2. **API客户端** (`Xingyun3dClient`)
   - PPT文件解析
   - 创建渲染任务（segment方式）
   - 创建渲染任务（PPT方式）
   - 查询任务状态
   - 取消任务
   - 视频下载和OSS上传

3. **Provider模式**
   - `VideoSynthesisProvider` 接口
   - `Easegen2DProvider` 2D提供者（复用现有逻辑）
   - `Xingyun3DProvider` 3D提供者（新增）

4. **Service层升级**
   - `CourseMediaServiceImpl` 集成Provider模式
   - 支持2D和3D两种模式

5. **定时任务升级**
   - `CourseMediaMegerJob` 支持3D任务状态查询

### 3.2 代码结构

```
yudao-module-digitalcourse/yudao-module-digitalcourse-biz/
├── util/
│   └── xingyun3d/
│       ├── Xingyun3dClient.java          # API客户端
│       └── Xingyun3dSignatureUtil.java   # 签名工具
├── service/
│   └── coursemedia/
│       ├── provider/
│       │   ├── VideoSynthesisProvider.java  # 提供者接口
│       │   ├── Easegen2DProvider.java      # 2D提供者
│       │   └── Xingyun3DProvider.java      # 3D提供者
│       ├── CourseMediaServiceImpl.java     # Service实现（已升级）
│       └── CourseMediaServiceUtil.java     # 2D工具类（保持不变）
└── job/
    └── CourseMediaMegerJob.java            # 定时任务（已升级）
```

---

## 四、使用说明

### 4.1 创建3D数字人视频合成任务

#### 方式一：通过segment（文本片段）

```json
POST /digitalcourse/course-media/meger
{
    "id": 1,
    "name": "测试课程",
    "platformType": 2,
    "lookName": "caihongwei_3663_new",
    "ttsVcnName": "XMOV_EN_TTS__13",
    "studioName": "telestudio_simple_red_01",
    "subTitle": "on",
    "ifAigcMark": 1,
    "synthesisType": "segment",
    "reqJson": {
        "segments": [
            {
                "text": "这是一条测试数据。",
                "media_url": "https://example.com/image1.jpg"
            },
            {
                "text": "测试数据片段1",
                "media_url": "https://example.com/image2.jpg"
            }
        ]
    }
}
```

#### 方式二：通过PPT文件

```json
POST /digitalcourse/course-media/meger
{
    "id": 1,
    "name": "测试课程",
    "platformType": 2,
    "lookName": "caihongwei_3663_new",
    "ttsVcnName": "XMOV_EN_TTS__13",
    "studioName": "telestudio_simple_red_01",
    "subTitle": "on",
    "ifAigcMark": 1,
    "synthesisType": "ppt",
    "pptFileUrl": "https://oss.example.com/ppt/course.pptx"
}
```

### 4.2 查询任务状态

定时任务会自动查询任务状态，也可以通过以下方式查询：

```java
// 查询任务状态（由定时任务自动调用）
CourseMediaDO courseMedia = courseMediaMapper.selectById(courseMediaId);
VideoSynthesisProvider provider = getProvider(courseMedia.getPlatformType());
provider.queryTaskStatus(courseMedia);
```

### 4.3 取消任务

```json
POST /digitalcourse/course-media/cancel
{
    "courseMediaId": 123
}
```

---

## 五、注意事项

### 5.1 配置要求

1. **必须配置项**
   - `xingyun3d.app.id`: 必须配置有效的App ID（从魔珐星云平台获取）
   - `xingyun3d.app.secret`: 必须配置有效的App Secret（从魔珐星云平台获取）

2. **可选配置项**
   - `xingyun3d.gateway.server`: 默认值为 `https://nebula-agent.xingyun3d.com`（通常不需要修改）

3. **代码默认值**（无需配置）
   - 功能默认启用，无需配置开关
   - 超时时间：30秒（硬编码在代码中）
   - 重试次数：3次（硬编码在代码中）

### 5.2 兼容性

1. **向后兼容**
   - 现有2D功能完全不受影响
   - `platformType` 默认为1（2D模式）
   - 现有接口保持不变

2. **数据迁移**
   - 执行SQL脚本后，现有数据的 `platform_type` 自动设置为1（2D）
   - 3D相关字段为空，不影响现有功能

### 5.3 错误处理

1. **配置错误**
   - 如果配置项缺失或无效，会抛出明确的错误信息
   - 建议在系统启动时检查配置

2. **API调用失败**
   - 实现重试机制（默认3次）
   - 错误信息记录到 `errorReason` 字段
   - 任务状态更新为失败（status=3）

3. **网络异常**
   - 设置超时时间（默认30秒）
   - 实现重试机制
   - 记录详细错误日志

---

## 六、测试建议

### 6.1 功能测试

1. **配置测试**
   - 测试配置项是否正确读取
   - 测试配置项缺失时的错误处理

2. **创建任务测试**
   - 测试segment方式创建任务
   - 测试PPT方式创建任务
   - 测试参数验证

3. **状态查询测试**
   - 测试定时任务状态查询
   - 测试任务状态更新

4. **取消任务测试**
   - 测试取消任务功能

### 6.2 异常测试

1. **网络异常**
   - 测试超时处理
   - 测试重试机制

2. **API错误**
   - 测试错误码处理
   - 测试错误信息记录

3. **配置错误**
   - 测试配置缺失
   - 测试配置无效

---

## 七、常见问题

### Q1: 如何启用3D数字人功能？

A: 3D数字人功能默认启用，只需配置 `xingyun3d.app.id` 和 `xingyun3d.app.secret` 即可。前端通过接口参数 `platformType` 来选择使用2D还是3D模式。

### Q2: 如何获取魔珐星云的App ID和Secret？

A: 登录魔珐星云平台（https://xingyun3d.com/），在"应用中心"创建应用，获取App ID和Secret。

### Q3: 2D和3D功能可以同时使用吗？

A: 可以，系统支持2D和3D两种模式，通过 `platformType` 参数切换。

### Q4: 任务状态如何查询？

A: 定时任务会自动查询任务状态，也可以通过API手动查询。

### Q5: 如何取消任务？

A: 调用取消任务接口，传入 `courseMediaId` 参数。

---

## 八、参考资料

- [数字人视频生成API说明](./数字人视频生成API说明.md)
- [PPT文件上传格式规范](./PPT文件上传格式规范.md)
- [魔珐星云数字人API接口文档](./魔珐星云数字人API接口文档.md)
- [3D数字人视频合成升级改造方案](./3D数字人视频合成升级改造方案.md)

---

**文档版本**: v1.0  
**创建日期**: 2025-01-06  
**维护者**: Easegen开发团队

