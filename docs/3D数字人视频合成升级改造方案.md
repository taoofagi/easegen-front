# 3D数字人视频合成升级改造方案

## 一、概述

### 1.1 背景
- 现有系统已实现2D数字人视频合成功能，通过调用外部easegen核心服务完成
- 需要接入魔珐星云3D数字人视频合成API，支持3D数字人视频生成
- 目标：统一后端接口，支持2D和3D两种模式，复用现有表结构和组件

### 1.2 改造目标
1. **统一接口**：提供统一的视频合成接口，支持2D和3D两种模式
2. **复用表结构**：尽量复用现有的`digitalcourse_course_media`表
3. **复用组件**：复用OSS文件存储、定时任务等组件
4. **配置管理**：通过配置项管理不同服务商的配置
5. **向后兼容**：保持现有2D功能正常工作

---

## 二、现有架构分析

### 2.1 现有2D数字人视频合成流程

```
用户请求 → CourseMediaController 
         → CourseMediaService 
         → CourseMediaServiceUtil.remoteMegerMedia() 
         → 调用easegen核心服务(/api/mergemedia)
         → 定时任务轮询结果(CourseMediaMegerJob)
         → 更新CourseMediaDO状态
```

### 2.2 现有表结构

**digitalcourse_course_media 表**：
- `id`: 主键
- `status`: 状态 (1、合成中，2、成功，3、失败)
- `duration`: 时长
- `finishTime`: 合成时间
- `mediaType`: 媒体类型
- `name`: 名称
- `previewUrl`: 媒体链接
- `progress`: 进度
- `courseId`: 课程id
- `courseName`: 课程名称
- `reqJson`: 请求报文
- `errorReason`: 错误原因
- `subtitlesUrl`: 字幕文件
- `subtitlesVttUrl`: vtt字幕文件
- `thumbnail`: 缩略图

### 2.3 现有配置

通过`ConfigApi`读取配置：
- `easegen.core.url`: 2D核心服务地址
- `easegen.core.key`: 2D核心服务密钥

---

## 三、升级改造方案

### 3.1 数据库表结构升级

#### 方案：复用现有表，新增字段

**digitalcourse_course_media 表新增字段**：

```sql
ALTER TABLE digitalcourse_course_media 
ADD COLUMN platform_type TINYINT DEFAULT 1 COMMENT '平台类型：1-2D（easegen），2-3D（魔珐星云）',
ADD COLUMN platform_task_id VARCHAR(64) COMMENT '平台任务ID（如魔珐星云的task_id）',
ADD COLUMN look_name VARCHAR(128) COMMENT '数字人形象名称（3D使用）',
ADD COLUMN tts_vcn_name VARCHAR(128) COMMENT '音色名称（3D使用）',
ADD COLUMN studio_name VARCHAR(128) COMMENT '演播室名称（3D使用）',
ADD COLUMN sub_title VARCHAR(10) DEFAULT 'on' COMMENT '字幕开关：on/off（3D使用）',
ADD COLUMN if_aigc_mark TINYINT DEFAULT 1 COMMENT '是否显示AI生成标识：0-否，1-是（3D使用）',
ADD COLUMN parse_ppt_file_name VARCHAR(128) COMMENT 'PPT解析文件名（3D使用）',
ADD COLUMN synth_status VARCHAR(20) COMMENT '合成状态：not_send/waiting/processing/finished/error/cancel（3D使用）',
ADD COLUMN synth_start_time DATETIME COMMENT '合成开始时间（3D使用）',
ADD COLUMN synth_finish_time DATETIME COMMENT '合成完成时间（3D使用）';
```

**说明**：
- `platform_type`: 区分2D和3D模式
- `platform_task_id`: 存储第三方平台的任务ID（如魔珐星云的task_id）
- 其他字段：3D模式专用字段，2D模式下可为空

### 3.2 配置项升级

#### 新增配置项

在系统配置表（`infra_config`）或`application.yaml`中新增：

```yaml
# 魔珐星云配置
xingyun3d:
  enabled: true  # 是否启用3D数字人
  app-id: ${XINGYUN3D_APP_ID:your_app_id}  # 应用ID
  app-secret: ${XINGYUN3D_APP_SECRET:your_app_secret}  # 应用密钥
  gateway-server: https://nebula-agent.xingyun3d.com  # 网关地址
  timeout: 30000  # 请求超时时间（毫秒）
  retry-times: 3  # 重试次数
```

或通过配置管理界面配置：
- `xingyun3d.enabled`: 是否启用3D数字人
- `xingyun3d.app.id`: 魔珐星云App ID
- `xingyun3d.app.secret`: 魔珐星云App Secret
- `xingyun3d.gateway.server`: 网关地址
- `xingyun3d.timeout`: 请求超时时间
- `xingyun3d.retry.times`: 重试次数

### 3.3 代码结构升级

#### 3.3.1 目录结构

```
yudao-module-digitalcourse/yudao-module-digitalcourse-biz/src/main/java/cn/iocoder/yudao/module/digitalcourse/
├── service/
│   ├── coursemedia/
│   │   ├── CourseMediaService.java          # 统一接口（保持不变）
│   │   ├── CourseMediaServiceImpl.java       # 实现类（升级）
│   │   ├── CourseMediaServiceUtil.java       # 工具类（保持不变，用于2D）
│   │   └── provider/                        # 新增：策略模式
│   │       ├── VideoSynthesisProvider.java   # 视频合成提供者接口
│   │       ├── Easegen2DProvider.java       # 2D提供者（现有逻辑迁移）
│   │       └── Xingyun3DProvider.java       # 3D提供者（新增）
│   └── ...
├── util/
│   └── xingyun3d/                           # 新增：魔珐星云工具包
│       ├── Xingyun3dClient.java             # HTTP客户端
│       ├── Xingyun3dSignatureUtil.java      # 签名工具
│       └── Xingyun3dConverter.java          # 数据转换器
└── ...
```

#### 3.3.2 核心类设计

##### 1. VideoSynthesisProvider 接口（策略模式）

```java
package cn.iocoder.yudao.module.digitalcourse.service.coursemedia.provider;

import cn.iocoder.yudao.module.digitalcourse.controller.admin.coursemedia.vo.CourseMediaMegerVO;
import cn.iocoder.yudao.module.digitalcourse.dal.dataobject.coursemedia.CourseMediaDO;

/**
 * 视频合成提供者接口
 */
public interface VideoSynthesisProvider {
    
    /**
     * 获取平台类型：1-2D，2-3D
     */
    Integer getPlatformType();
    
    /**
     * 创建视频合成任务
     */
    void createSynthesisTask(CourseMediaDO courseMedia, CourseMediaMegerVO mergeVO);
    
    /**
     * 查询任务状态
     */
    void queryTaskStatus(CourseMediaDO courseMedia);
    
    /**
     * 取消任务
     */
    void cancelTask(Long courseMediaId);
    
    /**
     * 是否支持该类型
     */
    boolean supports(Integer platformType);
}
```

##### 2. Easegen2DProvider 实现（现有2D逻辑）

```java
package cn.iocoder.yudao.module.digitalcourse.service.coursemedia.provider;

import cn.iocoder.yudao.module.digitalcourse.service.coursemedia.CourseMediaServiceUtil;
import org.springframework.stereotype.Component;

/**
 * Easegen 2D数字人提供者
 */
@Component
public class Easegen2DProvider implements VideoSynthesisProvider {
    
    @Resource
    private CourseMediaServiceUtil courseMediaServiceUtil;
    
    @Override
    public Integer getPlatformType() {
        return 1; // 2D
    }
    
    @Override
    public void createSynthesisTask(CourseMediaDO courseMedia, CourseMediaMegerVO mergeVO) {
        // 调用现有的2D逻辑
        courseMediaServiceUtil.remoteMegerMedia(mergeVO);
    }
    
    @Override
    public void queryTaskStatus(CourseMediaDO courseMedia) {
        // 调用现有的查询逻辑
        courseMediaServiceUtil.queryRemoteMegerResult();
    }
    
    @Override
    public void cancelTask(Long courseMediaId) {
        // 2D暂不支持取消
    }
    
    @Override
    public boolean supports(Integer platformType) {
        return platformType == 1;
    }
}
```

##### 3. Xingyun3DProvider 实现（新增3D逻辑）

```java
package cn.iocoder.yudao.module.digitalcourse.service.coursemedia.provider;

import cn.iocoder.yudao.module.digitalcourse.util.xingyun3d.Xingyun3dClient;
import org.springframework.stereotype.Component;

/**
 * 魔珐星云 3D数字人提供者
 */
@Component
public class Xingyun3DProvider implements VideoSynthesisProvider {
    
    @Resource
    private Xingyun3dClient xingyun3dClient;
    
    @Override
    public Integer getPlatformType() {
        return 2; // 3D
    }
    
    @Override
    public void createSynthesisTask(CourseMediaDO courseMedia, CourseMediaMegerVO mergeVO) {
        // 调用魔珐星云API创建任务
        xingyun3dClient.createRenderTask(courseMedia, mergeVO);
    }
    
    @Override
    public void queryTaskStatus(CourseMediaDO courseMedia) {
        // 查询魔珐星云任务状态
        xingyun3dClient.queryRenderTask(courseMedia);
    }
    
    @Override
    public void cancelTask(Long courseMediaId) {
        // 取消魔珐星云任务
        xingyun3dClient.cancelRenderTask(courseMediaId);
    }
    
    @Override
    public boolean supports(Integer platformType) {
        return platformType == 2;
    }
}
```

##### 4. CourseMediaServiceImpl 升级（统一入口）

```java
// 在现有实现类中添加
@Resource
private List<VideoSynthesisProvider> providers;

/**
 * 获取视频合成提供者
 */
private VideoSynthesisProvider getProvider(Integer platformType) {
    return providers.stream()
        .filter(p -> p.supports(platformType))
        .findFirst()
        .orElseThrow(() -> new ServiceException("不支持的平台类型：" + platformType));
}

/**
 * 创建视频合成任务（统一入口）
 */
public CommonResult createSynthesisTask(CourseMediaMegerVO mergeVO) {
    CourseMediaDO courseMedia = getCourseMedia(mergeVO.getCourseMediaId());
    Integer platformType = courseMedia.getPlatformType() != null 
        ? courseMedia.getPlatformType() 
        : 1; // 默认2D
    
    VideoSynthesisProvider provider = getProvider(platformType);
    provider.createSynthesisTask(courseMedia, mergeVO);
    
    return success();
}
```

##### 5. Xingyun3dClient（魔珐星云客户端）

```java
package cn.iocoder.yudao.module.digitalcourse.util.xingyun3d;

/**
 * 魔珐星云API客户端
 */
@Component
@Slf4j
public class Xingyun3dClient {
    
    @Resource
    private ConfigApi configApi;
    
    @Resource
    private FileService fileService; // 复用OSS存储
    
    /**
     * 创建渲染任务
     */
    public void createRenderTask(CourseMediaDO courseMedia, CourseMediaMegerVO mergeVO) {
        // 1. 根据mergeVO判断是segment还是PPT方式
        // 2. 如果是PPT，先调用parsePptFile
        // 3. 调用createRenderTask
        // 4. 保存platform_task_id到courseMedia
        // 5. 更新状态为合成中
    }
    
    /**
     * 查询任务状态
     */
    public void queryRenderTask(CourseMediaDO courseMedia) {
        // 1. 调用getRenderTask API
        // 2. 更新courseMedia状态
        // 3. 如果完成，下载视频到OSS并更新previewUrl
    }
    
    /**
     * 取消任务
     */
    public void cancelRenderTask(Long courseMediaId) {
        // 调用cancelRenderTask API
    }
    
    /**
     * 解析PPT文件
     */
    public String parsePptFile(String pptUrl) {
        // 1. 从OSS下载PPT文件
        // 2. 调用parse_ppt_file API
        // 3. 返回parse_ppt_file_name
    }
    
    /**
     * 生成签名
     */
    private String generateToken(String apiPath, String method, Object data) {
        // 实现X-TOKEN签名算法
    }
}
```

##### 6. Xingyun3dSignatureUtil（签名工具）

```java
package cn.iocoder.yudao.module.digitalcourse.util.xingyun3d;

/**
 * 魔珐星云签名工具
 */
public class Xingyun3dSignatureUtil {
    
    /**
     * 生成X-TOKEN
     */
    public static String generateToken(String apiPath, String method, 
                                       Object data, String secret, Long timestamp) {
        // 1. apiPath转小写
        String lowerApiPath = apiPath.toLowerCase();
        
        // 2. method转小写
        String lowerMethod = method.toLowerCase();
        
        // 3. data转JSON（排序，无空格）
        String sortJsonStr = JSON.toJSONString(data, 
            SerializerFeature.SortField, 
            SerializerFeature.DisableCircularReferenceDetect)
            .replace(" ", "");
        
        // 4. 拼接签名字符串
        String signStr = lowerApiPath + lowerMethod + sortJsonStr + secret + timestamp;
        
        // 5. MD5加密
        return DigestUtils.md5Hex(signStr);
    }
}
```

### 3.4 定时任务升级

#### 现有定时任务改造

**CourseMediaMegerJob.java** 升级：

```java
@Slf4j
@Component
public class CourseMediaMegerJob {
    
    @Resource
    private CourseMediaService courseMediaService;
    
    @Resource
    private List<VideoSynthesisProvider> providers;
    
    /**
     * 查询视频合成任务状态
     */
    @Scheduled(fixedDelay = 30000) // 每30秒执行一次
    public void querySynthesisTaskStatus() {
        // 1. 查询所有合成中的任务（status=1）
        List<CourseMediaDO> tasks = courseMediaService.getSynthesizingTasks();
        
        // 2. 按平台类型分组
        Map<Integer, List<CourseMediaDO>> tasksByPlatform = tasks.stream()
            .collect(Collectors.groupingBy(
                t -> t.getPlatformType() != null ? t.getPlatformType() : 1
            ));
        
        // 3. 调用对应的Provider查询状态
        tasksByPlatform.forEach((platformType, taskList) -> {
            VideoSynthesisProvider provider = getProvider(platformType);
            taskList.forEach(task -> {
                try {
                    provider.queryTaskStatus(task);
                } catch (Exception e) {
                    log.error("查询任务状态失败，taskId: {}", task.getId(), e);
                }
            });
        });
    }
}
```

### 3.5 Controller层升级

#### CourseMediaController 升级

```java
@RestController
@RequestMapping("/digitalcourse/course-media")
public class CourseMediaController {
    
    @PostMapping("/create-synthesis")
    @Operation(summary = "创建视频合成任务（统一接口）")
    public CommonResult<Long> createSynthesisTask(
            @Valid @RequestBody CourseMediaSynthesisReqVO reqVO) {
        // 1. 根据reqVO创建CourseMediaDO
        // 2. 设置platformType（前端传参或默认2D）
        // 3. 调用service创建任务
        Long courseMediaId = courseMediaService.createSynthesisTask(reqVO);
        return success(courseMediaId);
    }
    
    @PostMapping("/cancel-synthesis")
    @Operation(summary = "取消视频合成任务")
    public CommonResult<Boolean> cancelSynthesisTask(@RequestParam Long courseMediaId) {
        courseMediaService.cancelSynthesisTask(courseMediaId);
        return success(true);
    }
}
```

### 3.6 VO对象升级

#### 新增请求VO

```java
/**
 * 视频合成请求VO（统一接口）
 */
@Data
public class CourseMediaSynthesisReqVO {
    
    /**
     * 平台类型：1-2D，2-3D
     */
    private Integer platformType = 1; // 默认2D
    
    /**
     * 课程ID
     */
    private Long courseId;
    
    // === 2D模式参数 ===
    // 现有2D参数保持不变
    
    // === 3D模式参数 ===
    /**
     * 数字人形象名称
     */
    private String lookName;
    
    /**
     * 音色名称
     */
    private String ttsVcnName;
    
    /**
     * 演播室名称
     */
    private String studioName;
    
    /**
     * 字幕开关：on/off
     */
    private String subTitle = "on";
    
    /**
     * 是否显示AI生成标识
     */
    private Boolean ifAigcMark = true;
    
    /**
     * 视频名称
     */
    private String videoName;
    
    /**
     * 合成方式：segment-文本片段，ppt-PPT文件
     */
    private String synthesisType;
    
    /**
     * 文本片段（segment方式）
     */
    private List<SegmentVO> segments;
    
    /**
     * PPT文件URL（ppt方式）
     */
    private String pptFileUrl;
}

/**
 * 文本片段VO
 */
@Data
public class SegmentVO {
    private String text;
    private String mediaUrl; // 背景图片URL
}
```

---

## 四、实施步骤

### 阶段一：基础准备（1-2天）
1. ✅ 数据库表结构升级（新增字段）
2. ✅ 配置项添加（魔珐星云配置）
3. ✅ 创建工具类（Xingyun3dClient、Xingyun3dSignatureUtil）

### 阶段二：核心功能开发（3-5天）
1. ✅ 实现VideoSynthesisProvider接口
2. ✅ 实现Xingyun3DProvider
3. ✅ 重构CourseMediaServiceImpl（策略模式）
4. ✅ 实现魔珐星云API调用（创建任务、查询状态、取消任务）

### 阶段三：PPT支持（1-2天）
1. ✅ 实现PPT解析功能
2. ✅ 实现PPT文件上传到OSS
3. ✅ 集成PPT方式创建任务

### 阶段四：定时任务升级（1天）
1. ✅ 升级CourseMediaMegerJob
2. ✅ 支持按平台类型查询任务状态

### 阶段五：接口升级（1天）
1. ✅ 升级Controller
2. ✅ 新增统一VO
3. ✅ 接口文档更新

### 阶段六：测试与优化（2-3天）
1. ✅ 单元测试
2. ✅ 集成测试
3. ✅ 性能优化
4. ✅ 错误处理完善

---

## 五、复用组件说明

### 5.1 OSS文件存储（FileService）

**复用场景**：
- PPT文件上传到OSS
- 视频文件从魔珐星云下载后上传到OSS
- 字幕文件处理

**使用方式**：
```java
@Resource
private FileService fileService;

// 上传PPT文件
String pptUrl = fileService.createFile(pptFile.getOriginalFilename(), 
    "ppt/" + fileName, pptFile.getBytes());

// 下载视频并上传到OSS
byte[] videoBytes = downloadFromUrl(videoUrl);
String ossUrl = fileService.createFile("video.mp4", 
    "video/" + videoName, videoBytes);
```

### 5.2 定时任务框架

**复用场景**：
- 任务状态轮询
- 失败任务重试

**使用方式**：
```java
@Scheduled(fixedDelay = 30000)
public void queryTaskStatus() {
    // 查询任务状态
}
```

### 5.3 配置管理（ConfigApi）

**复用场景**：
- 读取魔珐星云配置
- 读取2D服务配置

**使用方式**：
```java
@Resource
private ConfigApi configApi;

String appId = configApi.getConfigValueByKey("xingyun3d.app.id");
String secret = configApi.getConfigValueByKey("xingyun3d.app.secret");
```

---

## 六、兼容性说明

### 6.1 向后兼容

1. **现有2D功能**：完全兼容，不影响现有业务
2. **现有表结构**：新增字段，默认值兼容2D
3. **现有接口**：保持现有接口不变，新增统一接口

### 6.2 迁移策略

1. **数据迁移**：现有数据`platform_type`默认为1（2D）
2. **接口迁移**：逐步迁移到统一接口，保留旧接口
3. **配置迁移**：新增配置项，不影响现有配置

---

## 七、注意事项

### 7.1 错误处理

1. **网络异常**：实现重试机制
2. **API调用失败**：记录错误信息到`errorReason`
3. **任务超时**：设置超时时间，超时后标记为失败

### 7.2 性能优化

1. **批量查询**：定时任务批量查询任务状态
2. **异步处理**：视频下载和上传异步处理
3. **缓存配置**：缓存魔珐星云配置，避免频繁读取

### 7.3 安全性

1. **密钥管理**：配置项加密存储
2. **签名校验**：严格按照文档实现签名算法
3. **权限控制**：接口权限控制

---

## 八、测试要点

### 8.1 功能测试

1. ✅ 2D模式创建任务（确保不影响）
2. ✅ 3D模式创建任务（segment方式）
3. ✅ 3D模式创建任务（PPT方式）
4. ✅ 任务状态查询
5. ✅ 任务取消
6. ✅ 视频下载和OSS上传

### 8.2 异常测试

1. ✅ 网络异常重试
2. ✅ API调用失败处理
3. ✅ 任务超时处理
4. ✅ 配置缺失处理

### 8.3 性能测试

1. ✅ 并发创建任务
2. ✅ 定时任务性能
3. ✅ 大文件上传下载

---

## 九、后续优化方向

1. **多平台支持**：支持更多视频合成平台
2. **任务队列**：使用消息队列管理任务
3. **监控告警**：添加任务监控和告警
4. **成本控制**：统计各平台使用成本
5. **智能选择**：根据场景自动选择最优平台

---

## 十、参考资料

- [数字人视频生成API说明](./数字人视频生成API说明.md)
- [PPT文件上传格式规范](./PPT文件上传格式规范.md)
- [魔珐星云数字人API接口文档](./魔珐星云数字人API接口文档.md)

---

**文档版本**: v1.0  
**创建日期**: 2025-01-06  
**维护者**: Easegen开发团队

